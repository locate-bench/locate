<html>
  <head>
    <title>Temporal Action Localization Visualizations</title>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js'></script>    
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js'></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js'></script>
	<script
		src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
		integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<link href="https://cdn.jsdelivr.net/npm/busy-load/dist/app.min.css" rel="stylesheet">
  	<style>
		.controls button[data-state="subtitles"] {
    		height:85%;
    		text-indent:0;
    		font-size:16px;
    		font-size:1rem;
    		font-weight:bold;
    		color:#666;
    		background:#000;
    		border-radius:2px;
		}
		.vid {
			height: 300px;
		}
  	</style>
  </head>
  <body>
    <div class='container-fluid'>
			<h3>Temporal Action Localization Visualizations</h3> 
			<p>
	  		<ul>
				<li>Total # videos = <span id=num_videos></span>.</li>
	  		</ul>
			</p>
			<p>
				<table class="table" id="results-table">
  		    	<!-- <caption><b>Annotations from Exp. 1</b></caption> -->
  		    	<thead>
				  <tr>
					  <!--<th scope="col"><b>#</b></th>-->
					  <th scope="col"><b>Index</b></th>  						
		  		      <th scope="col"><b>Human A</b></th>
		  		      <th scope="col"><b>Human B</b></th>  		      
		  		      <th scope="col"><b>Playback Speed</b></th>
		  		      <th scope="col"><b>Actions</b></th>
				  </tr>
  		    </thead>
  		    <tbody>
  		    </tbody>
  		  </table>
			</p>
  	</div>

  	<script type="text/javascript">
		

      $(function() {


		// Display video and the actions in it
		function add_vid_html() {
			// Adapted from: https://iandevlin.com/blog/2015/02/javascript/dynamically-adding-text-tracks-to-html5-video/
			// console.log(vid_act_map);
			var list_vids = Object.keys(vid_act_map);
			// console.log(vid_act_map[list_vids[0]]);
			const all_action_list = ["walk", 'hit or punch', "kick", 'run or jog', 'jump or hop or leap', 'throw', 'catch', 'step',
			'greet', 'dance', 'stretch or yoga or exercise / training', 'turn or spin', 'bend', 'stand', 'sit', 'kneel',
			'place something', 'grasp object', 'take/pick something up or lift something', 'scratch or touching face or touching body parts'];
			for (var i=0; i < list_vids.length; i++) {

				// Create video frame in HTML
				var gt_html5_vid = '<video class="vid" id="gt-video-'+ i +'" controls preload="metadata"><source src="' +
								list_vids[i] + '" type="video/mp4"></video>';
				var pred_html5_vid = '<video class="vid" id="pred-video-'+ i +'" controls preload="metadata"><source src="' +
								list_vids[i] + '" type="video/mp4"></video>';

				// Create playback speed controls
				var pb_speed = '<button id="speed-up-video-'+i+'" onclick="speed_up('+i+')" class="btn btn-secondary">+</button><br><br>';
				pb_speed += '<button id="slow-down-video-'+i+'" onclick="slow_down('+i+')" class="btn btn-secondary">-</button><br><br>';
				pb_speed += 'Playback speed: <span id="pb-speed-video-'+i+'">1.0</span>';

				// Get action information
				var preprocess_gt_actions = vid_act_map[list_vids[i]]['gt_segments'].map(x => x['action']);
				preprocess_gt_actions = Array.from(new Set(preprocess_gt_actions))
				// '<font color=“blue”>' + action + '</font>'
				gt_actions = ""
				for (let i = 0; i < preprocess_gt_actions.length; i++) {
					let action = preprocess_gt_actions[i]
					if (all_action_list.includes(action)) {
						gt_actions = gt_actions + action + '<br>';
					}
					else {
						gt_actions = gt_actions + '<p style="color:grey;margin:0">' + action + '</p>';
					}
					// console.log(action);
				}
				var pred_actions = vid_act_map[list_vids[i]]['pred_segments'].map(x => x['action']);
				pred_actions = Array.from(new Set(pred_actions)).join('<br>');

				// Add video, playback control, action information to table
				var vid_html = '<tr><td>'+vid_act_map[list_vids[i]]['index']+
					'</td><td>'+ gt_html5_vid+'</td><td>'+ pred_html5_vid +'</td><td>'+
				pb_speed + '</td><td><b>Human A Actions:</b><br>'+gt_actions+
					'<br><br><b>Human B Actions:</b><br>'+pred_actions+'</td></tr>';
          		$(vid_html).appendTo("#results-table tbody");

				// Subtitle track for GT
				var video = document.getElementById("gt-video-" + i), track;
				video.addEventListener("loadedmetadata", function () {
					track = this.addTextTrack("captions", "English", "en");
					track.mode = "showing";
					for (var seg_idx in vid_act_map[this.firstElementChild.src]['gt_segments']) {
						var seg = vid_act_map[this.firstElementChild.src]['gt_segments'][seg_idx];
						track.addCue(new VTTCue(seg['start'], seg['end'], seg['action']));
					}
				});
				// Subtitle track for Preds
				var video = document.getElementById("pred-video-" + i), track;
				video.addEventListener("loadedmetadata", function () {
					track = this.addTextTrack("captions", "English", "en");
					track.mode = "showing";
					for (var seg_idx in vid_act_map[this.firstElementChild.src]['pred_segments']) {
						var seg = vid_act_map[this.firstElementChild.src]['pred_segments'][seg_idx];
						track.addCue(new VTTCue(seg['start'], seg['end'], seg['action']));
					}
				});
				
			}
		}

		// Read data and store list of videos and their annotations
		var test_vid_act_map = {'https://babel-renders.s3.eu-central-1.amazonaws.com/011523.mp4':
									{
										'index': 0,
										'gt_segments': [
											{'start': 73.675,
											'end': 75.425,
											'action': 'stretch'
											},
											{'start': 24.259,
											'end': 26.009,
											'action': 'touching body part'
											},
											{
												'start': 1.882,
												'end': 80.342,
												'action': 'sit'
											},
										],
										'pred_segments': [
											{'start': 1.285,
											'end': 4.535,
											'action': 'sit'
											},
											{'start': 24.472,
											'end': 25.753,
											'action': 'touching body part'
											},
											{
												'start': 56.444,
												'end': 58.694,
												'action': 'greet'
											},
											{
												'start': 73.569,
												'end': 75.319,
												'action': 'greet'
											},
											{
												'start': 4.535,
												'end': 80.257,
												'action': 'sit'
											}
										]										
									},
									'https://babel-renders.s3.eu-central-1.amazonaws.com/009895.mp4':
			{
				'index': 1,
				'gt_segments': [
					{
						'start': 4.733,
						'end': 5.688,
						'action': 'turn'
					},
					{
						'start': 0,
						'end': 1.108,
						'action': 'walk'
					},
					{
						'start': 5.965,
						'end': 7.1,
						'action': 'walk'
					},
					{
						'start': 2.197,
						'end': 4.456,
						'action': 'lift something'
					},
					{
						'start': 2.197,
						'end': 4.456,
						'action': 'place something'
					},
				],
				'pred_segments': [
					{
						'start': 4.796,
						'end': 5.796,
						'action': 'turn'
					},
					{
						'start': 0,
						'end': 1.01,
						'action': 'walk'
					},
					{
						'start': 5.93,
						'end': 7.1,
						'action': 'walk'
					},
					{
						'start': 2.501,
						'end': 3.403,
						'action': 'lift something'
					},
					{
						'start': 3.59,
						'end': 4.608,
						'action': 'place something'
					},
				]
			},
			'https://babel-renders.s3.eu-central-1.amazonaws.com/001703.mp4':
			{
				'index': 2,
				'gt_segments': [
					{
						'start':  0.711,
						'end': 1.627,
						'action': 'turn'
					},
					{
						'start': 3.611,
						'end': 7.002,
						'action': 'turn'
					},
					{
						'start': 11.273,
						'end': 12.565,
						'action': 'turn'
					},
					{
						'start': 13.231,
						'end': 14.169,
						'action': 'turn'
					},
					{
						'start': 14.94,
						'end': 16.086,
						'action': 'turn'
					},
					{
						'start': 18.544,
						'end': 19.69,
						'action': 'turn'
					},
					{
						'start': 22.836,
						'end': 25.69,
						'action': 'turn'
					},
					{
						'start': 4.19,
						'end': 4.773,
						'action': 'strech'
					},
					{
						'start': 13.981,
						'end': 15.19,
						'action': 'strech'
					},
					{
						'start': 16.065,
						'end': 17.606,
						'action': 'strech'
					},
					{
						'start': 18.648,
						'end': 19.377,
						'action': 'strech'
					},
					{
						'start': 8.252,
						'end': 11.961,
						'action': 'strech'
					},
					{
						'start': 12.336,
						'end': 13.669,
						'action': 'walk'
					},
					{
						'start': 18.002,
						'end': 22.023,
						'action': 'walk'
					},
					{
						'start': 23.023,
						'end': 27.3,
						'action': 'walk'
					},
				],
				'pred_segments': [
					{
						'start': 2.544,
						'end': 26.296,
						'action': 'stretch'
					},
				]
			},
			'https://babel-renders.s3.eu-central-1.amazonaws.com/002291.mp4':
			{
				'index': 3,
				'gt_segments': [
					{
						'start': 3.826,
						'end': 4.94,
						'action': 'turn'
					},
					{
						'start': 0,
						'end': 2.085,
						'action': 'walk'
					},
					{
						'start': 4.94,
						'end': 6.6,
						'action': 'walk'
					},
					{
						'start': 2.39,
						'end': 3.826,
						'action': 'stand'
					},
				],
				'pred_segments': [
					{
						'start': 4.121,
						'end': 5.163,
						'action': 'turn'
					},
					{
						'start': 0,
						'end': 2.246,
						'action': 'walk'
					},
					{
						'start': 4.855,
						'end': 6.6,
						'action': 'walk'
					},
					{
						'start': 2.246,
						'end': 3.92,
						'action': 'stand'
					},
				]
			},
			'https://babel-renders.s3.eu-central-1.amazonaws.com/004416.mp4':
			{
				'index': 4,
				'gt_segments': [
					{
						'start': 4.389,
						'end': 5.563,
						'action': 'turn'
					},
					{
						'start': 0,
						'end': 1.575,
						'action': 'walk'
					},
					{
						'start': 5.563,
						'end': 7.4,
						'action': 'walk'
					},
					{
						'start': 3.748,
						'end': 4.389,
						'action': 'place something'
					},
					{
						'start': 2.65,
						'end': 3.748,
						'action': 'take/pick something up'
					},
				],
				'pred_segments': [
					{
						'start': 0,
						'end': 1.56,
						'action': 'walk'
					},
					{
						'start': 5.32,
						'end': 7.4,
						'action': 'walk'
					},
					{
						'start': 3.8,
						'end': 4.3,
						'action': 'place something'
					},
					{
						'start': 3.04,
						'end': 3.58,
						'action': 'take/pick something up'
					},
				]
			},
								};
					
		// Global variable
		// var vid_act_map = {};
		vid_act_map = test_vid_act_map;
		$('#num_videos').text(Object.keys(vid_act_map).length);

		add_vid_html();

      });
	  function speed_up(idx) {
			var vid = document.getElementById('gt-video-' + idx);
			vid.playbackRate += 0.25;
			$('#pb-speed-video-' + idx).text(vid.playbackRate);
			var vid = document.getElementById('pred-video-' + idx);
			vid.playbackRate += 0.25
		}

		function slow_down(idx) {
			var vid = document.getElementById('gt-video-' + idx);
			if (vid.playbackRate >= 0.25) {
				vid.playbackRate -= 0.25;
			}
			$('#pb-speed-video-' + idx).text(vid.playbackRate);
			var vid = document.getElementById('pred-video-' + idx);
			if (vid.playbackRate >= 0.25) {
				vid.playbackRate -= 0.25;
			}
		}
    </script>

  </body>
</html>