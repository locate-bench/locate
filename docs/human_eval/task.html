<html>
  <head>
    <title>Which labels better match the motion?</title>
    <!-- simpleamt depends on these libraries -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>    
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js'></script>    
    <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js'></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script
    src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/busy-load/dist/app.min.css" rel="stylesheet">

  

    </script>
    <style>
      #button-div {
        margin-bottom: 10px;
      }
      #counter {
        margin: 0 10px;
        font-size: 14pt;
        font-weight: bold;
      }      
      #examples-table {
        font-size: 14pt;
      }
      video {
        height: 480px;
        background-size:cover;
      }
      td {
        padding: 5px;
      }
      table {
        font-size: 15px;
      }
	    li{
  		  margin: 8px 0;
	    }

      /* The Close Button */
      .close {
        color: #A9A9A9 /*#aaa; */
        float: right;
        font-size: 28px;
        font-weight: bold;
      }
      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }

      /* Submit Modal (background) */
      .modal {
        display: none; /* Hidden by default */
        position: fixed;  /*Stay in place */
        z-index: 1; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: none; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.4); /*  Black w/ opacity */
      }

      #check-radio-modal-content {
        background-color: #fefefe;
        margin: 15% auto; /* 15% from the top and centered */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Could be more or less, depending on screen size */
      }

      /* Modal Content/Box */
      #instructions-modal-content {
        background-color: #fefefe;
        margin: 2% auto; /* 2% from the top and centered */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Could be more or less, depending on screen size */
      }

      #submit-modal-content {
        background-color: #fefefe;
        margin: 10% auto; /* 10% from the top and centered */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Could be more or less, depending on screen size */
      }

    </style>
  </head>
  <body>
    <div class='container-fluid'>
      <!-- Blank space at the top of the page -->
      <div class='row'><br></div>

      <!-- Title -->
      <div class='row'>
        <br>
        <div class='col-md-3'></div>
        <div class='col'>
          <div class='row'>
            <h4><b>Which labels better match the motion (left or right) ?</b></h4>
          </div>
        </div>
      </div>

      <div class='row flex-row flex-nowrap'>
        <div class="col-md-1"></div>
        <div class='col-xs-4'>
          <button id="show-hide-instructions-btn" class='btn btn-sm btn-primary'>Show Instructions</button>
        </div>
      </div>
        
      <!-- Col 1: Videos, Radio buttons --> 
      <div class='row justify-content-center'>
        <div id='radio-button-container'>
          <!-- <p>Which labels better match the motion (left or right) ?</p> -->
          <table>
            <tr>
              <td width="300px" align="left">   
                <input type="radio" id="left" name="binary" value="left">
                <label for="left" style="font-size: 20px;">Left</label>
              </td>
              <td width="200px" align="right">              
                <input type="radio" id="right" name="binary" value="right">
                <label for="right" style="font-size: 20px;">Right</label><br>
              </td>
            </tr>
          </table>
        </div>
      </div>  
      </div>
      <div class='row flex-row flex-nowrap'>
        <div class='col-2'></div>
        <div class='col-xs-4'>
          <div class='row justify-content-center'>
            <table> 
              <tr>
                <td>       
                  <!-- Left Video -->       
                  <div align='center' id='left-image-container'></div>
                </td>
                <td>       
                  <!-- Right Video -->       
                  <div align='center' id='right-image-container'></div>
                </td>
              </tr>
            </table>
          </div>
            
          <hr>
          <!-- Prev/Next buttons and Video Counter -->
          <!-- <div class='row flex-row flex-nowrap'> -->
          <div class='row justify-content-center'>
            <br>
            <div class='col-xs-4 col-xs-offset-4 text-center' id='button-div'>
              <button id='prev-btn' class='btn btn-lg btn-primary' disabled>Back</button>
              <span id='counter'>
                <span class='counter-top'></span> / <span class='counter-bottom'></span>
              </span>
              <button id='next-btn' class='btn btn-lg btn-primary' disabled>Next</button>
            </div>
          </div>          
        </div>          

        <!-- Col 2: Empty buffer -->
        <div class='col-xs-1'>          
        </div>   

        <!-- Column 3: Instructions -->
        <div class='col-xs-7'>
          <div class="row"> 
            <!-- Instructions Modal -->
            <div id="instructions-modal" class="modal" style="display: block;">
              <div id="instructions-modal-content" style="width: 700px;">                
                <h4>Instructions</h4>
                <p style="font-family:roboto">  
                  You will see two videos with words describing the actions taking place. 
                  Your task is to decide which video has labels that best describe the action.
                </p>
                <p style="font-family:roboto">
                  <ul>
                    <li> Please watch the entire video before making your selection. </li>
                    <li> Please consider these while making your selection: 
                      <ol>
                        <li> How apt are the action labels for the movement? </li>
                        <li> How well does the action label coincide with the duration of that movement? </li>
                        <li> How thorough is the labeling, i.e., how many of the movements are labeled? </li>
                      </ol>
                    </li>                     
                    <li> We understand that the choice may be hard to make for some pairs of examples. Just do your best! </li>
                    <li> Feel free to reach out to us through the feedback at the end of the HIT. Or via email if you have questions, concerns or feedback. </li>
                  </ul>
                </p>
                <br>
                <button id="instructions-modal-ok-btn" class='btn btn-sm btn-primary'>OK</button>            
              </div>
            </div>

            <!-- Please check radio button modal -->
            <div id="check-radio-modal" class="modal mx-auto">
              <div id="check-radio-modal-content" style="width: 450px;">
                <span id="check-radio-modal-close-btn" class="close">&times;</span>
                <h4>Please answer the question before proceeding.</h4>
                <br>
                <button id="check-radio-modal-ok-btn" class='btn btn-sm btn-primary'>OK</button>
              </div>
            </div>             
          </div>
        </div>  <!-- End of Column 3 (instructions/examples buttons, instructions) --> 
      </div>  <!-- End of Row 2 (video, instructions/examples buttons, instructions) --> 

      <div id="submit-modal" class="modal mx-auto">
        <div id="submit-modal-content">
		  <span id="submit-modal-close-btn" class="close">&times;</span>
          <h3>Feedback and comments are welcome! Thanks!</h3>
          <textarea type="hidden" id="hit-comment" name="hit-comment" style="resize:none; height:10%; width:80%"></textarea>          
		  <br>
		  <br>
		  <form id='results-form' method='post' action='dummy' class='text-left'>
            <input type='submit' class='btn btn-sm btn-success' id='submit-btn' value='Submit' disabled/>
  			<input type='hidden' value='' name='assignmentId' id='assignmentId'/>
    		<input type='hidden' value='' name='output' id='output'/>
    	  </form>
		  <br>
          <button id="submit-modal-back-btn" class='btn btn-sm btn-primary'>Back</button>
        </div>
      </div>
    </div>

    <!-- From simpleamt.html -->
    <script type='text/json' id='json_input'>
      {{ json_input }}
    </script> 

    <script>

      var simpleamt = (function() {
  
        // Copied from http://james.padolsey.com/javascript/bujs-1-getparameterbyname/
        function getUrlParam(name) {
          var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
          return match ? decodeURIComponent(match[1].replace(/\+/g, ' ')) : null;
        }

        function getInput(default_input) {
          if (typeof(default_input) === 'undefined') default_input = null;
          try {
            return JSON.parse($('#json_input').html());
          } catch (e) {
            return default_input;
          }
        }

        function setOutput(output) {
          $('#output').val(JSON.stringify(output));
        }

        function isPreview() {
          var assignment_id = getUrlParam('assignmentId');
          if (assignment_id === null) return false;
          return assignment_id == 'ASSIGNMENT_ID_NOT_AVAILABLE';
        }

        function setupSubmit() {
          var submit_to = getUrlParam('turkSubmitTo');
          $('#results-form').attr('action', submit_to + '/mturk/externalSubmit');                      
          $('#assignmentId').val(getUrlParam('assignmentId'));
        }

        return {
          getInput: getInput,
          setOutput: setOutput,
          isPreview: isPreview,
          setupSubmit: setupSubmit,
        }

      })();


      $(function() {

        // Number of examples -- constant 
        var total_num_examples = 5;

        // Read data and store list of videos and their annotations
        var test_vid_act_map = { 
          0: {
            'https://babel-renders.s3.eu-central-1.amazonaws.com/008738.mp4': {
              'index': 0,                    
              'pred_segments': [
                {'start': 0,
                'end': 1,
                'action': 'walk'
                },
                {'start': 1,
                'end': 2,
                'action': 'stand'
                }
              ]                    
            }
          }, 
          1: {
            'https://babel-renders.s3.eu-central-1.amazonaws.com/008738.mp4': {
              'index': 0,
              'pred_segments': [
                {'start': 0.8,
                'end': 2,
                'action': 'walk'
                },
                {'start': 1,
                'end': 2,
                'action': 'stand'
                }
              ]                   
            }
          }
        };

        // Data for all videos
        var vid_act_map = null;
        var video_input = null;

        // Annotations for all videos. 
        var multiple_actions = []; 
        var method_label = [];

        // Some variables to track state of the HIT.
        var idx = 0;  // video idx
        var enabled = true;  // AC Edit

        var example_num = 0;

        function main() {
          // If this is a HIT on AMT, then replace the default input with the real input.
          vid_act_map = simpleamt.getInput(test_vid_act_map);
          video_input = Object.keys(vid_act_map[0]);
          
          // Randomize order -- only methods \in {0, 1}
          for (var i=0; i<video_input.length; i++) {
            var coin_toss = Math.round(Math.random());
            if (1 == coin_toss) {
              method_label.push([1, 0]);  
            }
            else {
              method_label.push([0, 1]); 
            }          
          }

          // Enable the UI if the HIT is not in preview mode.
          // AC Edit
          if (!simpleamt.isPreview()) {
		        enabled = true;
            enable_hit();
          }

          // Initialize empty action labels, radio buttons
          _.each(video_input, function() { 
          	multiple_actions.push(false);
          });

          // Preload all images
          var imgs = [];
          _.each(video_input, function(img_url) {
            var img = new Image();
            img.onload = function() { console.log('loaded image from ' + img_url); };
            img.src = img_url;
          });

          render();
        }

        function add_subtitles() {
          var video = document.getElementById("left-video"), track;
          video.addEventListener("loadedmetadata", function () {
            track = this.addTextTrack("captions", "English", "en");
            track.mode = "showing";
            var method = method_label[idx][0];
            var labels = vid_act_map[method][video_input[idx]]['pred_segments'];
            for (var seg_idx in labels) {
              var seg = labels[seg_idx];
              track.addCue(new VTTCue(seg['start'], seg['end'], seg['action']));
            }
          }); 
          var video = document.getElementById("right-video"), track;
          video.addEventListener("loadedmetadata", function () {
            track = this.addTextTrack("captions", "English", "en");
            track.mode = "showing";
            var method = method_label[idx][1];
            var labels = vid_act_map[method][video_input[idx]]['pred_segments'];
            for (var seg_idx in labels) {
              var seg = labels[seg_idx];
              track.addCue(new VTTCue(seg['start'], seg['end'], seg['action']));
            }
          }); 
        }

        function update_radio_button() {
          if (false === multiple_actions[idx]) {           
            // Clear radio button 
            $('input:radio').attr('checked', false);
          }
          else {
            $('#'+multiple_actions[idx]).prop('checked', true); 
          }          
        }

        // Use the current index to update the image and description
        function render() {

          // Set up the video
          $('#left-image-container').empty();
          $('#right-image-container').empty();
          $('<video id="left-video" controls>').attr('src', video_input[idx]).appendTo($('#left-image-container'));
          $('<video id="right-video" controls>').attr('src', video_input[idx]).appendTo($('#right-image-container'));
          add_subtitles();

          // Event on radio button click 
          $("input[type='radio']").unbind('click').bind('click', function () {
          	// Store button value 
            var radioValue = $("input[name='binary']:checked").val();
            multiple_actions[idx] = radioValue;

            update_radio_button();

          });

          // Show instructions modal 
          $('#show-hide-instructions-btn').unbind('click').bind('click', function (e) {
            var instructions = document.getElementById("instructions-modal");
            instructions.style.display = "block"; 
          });

          $('#longer-length-modal-close-btn').click(function() {
            var longer_length_modal = document.getElementById("longer-length-modal");
            longer_length_modal.style.display = "none";
          });
          $('#longer-length-modal-ok-btn').click(function() {
            var longer_length_modal = document.getElementById("longer-length-modal");
            longer_length_modal.style.display = "none";
          });
          $('#check-radio-modal-close-btn').click(function() {
            var longer_length_modal = document.getElementById("check-radio-modal");
            longer_length_modal.style.display = "none";
          });
          $('#check-radio-modal-ok-btn').click(function() {
            var longer_length_modal = document.getElementById("check-radio-modal");
            longer_length_modal.style.display = "none";
          });
          $('#instructions-modal-ok-btn').click(function() {
            var instructions_modal = document.getElementById("instructions-modal");
            instructions_modal.style.display = "none";
          });

          // Submit modal 
          $('#submit-modal-close-btn').click(function() {
            var submit_modal = document.getElementById("submit-modal");
            submit_modal.style.display = "none";
          });
          $('#submit-modal-back-btn').click(function() {
            var submit_modal = document.getElementById("submit-modal");
            submit_modal.style.display = "none";
          });

          // Refresh the counter
          $('.counter-top').text(idx + 1);
          $('.counter-bottom').text(video_input.length);

          // If the UI is enabled, enable/disable the buttons depending on idx
          if (enabled) {
            var prev_btn = $('#prev-btn');
            var next_btn = $('#next-btn');
            prev_btn.prop('disabled', true);
            next_btn.prop('disabled', true);
            if (idx > 0) {
              prev_btn.prop('disabled', false);
            }
            if (idx < video_input.length) next_btn.prop('disabled', false);
          }
        }        

        // Update the index, and save the text in the text area.
        function set_idx(new_idx) {
          if (new_idx < 0 || new_idx > video_input.length) {
          	return;
          }
          if (new_idx === video_input.length) {
            var submit_modal = document.getElementById('submit-modal');
            submit_modal.style.display = "block";
            return;
          } else {
  	        idx = new_idx;
  	        render();
            update_radio_button();
          }
        }

        function show_radio_unchecked_error() {
          var check_radio_modal = document.getElementById('check-radio-modal');
          check_radio_modal.style.display = "block";
          return;        	
        }

        // Enable the UI.
        function enable_hit() {

          // Enable components
          $('#next-btn').click(function() { 
            if (false === multiple_actions[idx]) {
              show_radio_unchecked_error();
            }           	
            else {
              set_idx(idx+1);
            }            
          });
          $('#prev-btn').click(function() { 
            set_idx(idx - 1);             
          });

          $('#submit-btn').prop('disabled', false);
          
          // Set up submit handler.
          simpleamt.setupSubmit();
          $('#submit-btn').click(function() {
            var hit_comment = $.trim($("#hit-comment").val());
            var annotations = _.map(_.zip(video_input, multiple_actions, method_label), function(x) {
              return {'video_url': x[0], 'multiple_actions': x[1], 'method_label': x[2]};
            });
            var output = {'annotations': annotations, 'hit_comment': hit_comment};
            simpleamt.setOutput(output);
          });
        }

        main();
      });
    
    </script>
  </body>
</html>
